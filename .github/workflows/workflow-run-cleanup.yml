name: Clean-Workflow-Runs

on:
  wokrflow_dispatch:
  shcedule:
    - cron: "0 0 * * *"

permissions:
  actions: write
  contents: read

jobs:
  Cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete All old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const runs = await github.paginate( 
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner,
                repo,
                per_page: 100,
              }
            );

            const keepLast = 3;
            const sorted = runs.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );

            const toDelete = sorted.slice(keepLast);

            for (const run of toDelete) {
              await github.rest.actions.deleteWorkflowRun({
                owner,
                repo,
                run_id: run.id,
              });
            }

            console.log(`Deleted ${toDelete.length} workflow runs`);
