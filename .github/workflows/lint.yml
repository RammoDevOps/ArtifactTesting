name: ğŸ” Lint GitHub Actions Workflows
on:
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
    branches:
      - main
  workflow_dispatch:  # Manual trigger

jobs:
  actionlint:
    name: ğŸ”§ ActionLint - Syntax Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better checks
          
      - name: ğŸ³ Run ActionLint
        uses: docker://rhysd/actionlint:latest
        with:
          args: |
            -color 
            -verbose
            -ignore 'labeler-event-missing'
            .github/workflows/
        
      - name: ğŸ“Š Lint Report
        if: success()
        run: |
          echo "âœ… All GitHub Actions workflows passed linting!"
          echo "ğŸ“‹ Files checked:"
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs -I {} basename {}
          
  yaml-syntax:
    name: ğŸ“ YAML Syntax Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ Install Python (for yaml parsing)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ğŸ“„ Validate YAML Files
        run: |
          echo "ğŸ” Validating YAML syntax for all workflow files..."
          ERROR_COUNT=0
          
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "ğŸ“‹ Checking: $(basename "$file")"
              
              # Basic YAML syntax check
              if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "   âœ… Valid YAML syntax"
              else
                echo "   âŒ Invalid YAML syntax in $file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
              
              # Check for common issues
              if grep -q "on: workflow_dispatch" "$file"; then
                echo "   â„¹ï¸  Contains manual trigger (workflow_dispatch)"
              fi
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT YAML syntax errors"
            exit 1
          else
            echo "âœ… All YAML files have valid syntax"
          fi

  workflow-structure:
    name: ğŸ—ï¸ Workflow Structure Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ§¹ Check Workflow Naming
        run: |
          echo "ğŸ”¤ Checking workflow naming conventions..."
          
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              
              # Check for kebab-case naming
              if [[ ! "$FILENAME" =~ ^[a-z0-9]+(-[a-z0-9]+)*\.(yml|yaml)$ ]]; then
                echo "âš ï¸  File '$FILENAME' should use kebab-case (e.g., 'my-workflow.yml')"
              fi
              
              # Check workflow name
              WORKFLOW_NAME=$(grep -E "^name:" "$file" | head -1 | cut -d: -f2- | sed 's/^ *//;s/ *$//' | tr -d '"'"'")
              if [ -n "$WORKFLOW_NAME" ]; then
                echo "ğŸ“ '$FILENAME' â†’ '$WORKFLOW_NAME'"
              else
                echo "âš ï¸  '$FILENAME' is missing a workflow name"
              fi
            fi
          done
          
      - name: ğŸ“Š Summary
        run: |
          echo "ğŸ“ˆ Workflow Statistics:"
          echo "========================"
          COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "Total workflows: $COUNT"
          
          echo ""
          echo "ğŸ” Trigger types found:"
          for trigger in push pull_request workflow_dispatch schedule; do
            FILES=$(grep -l "on:.*$trigger" .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true)
            if [ -n "$FILES" ]; then
              COUNT_FILES=$(echo "$FILES" | wc -l)
              echo "  â€¢ $trigger: $COUNT_FILES workflow(s)"
            fi
          done

  security-checks:
    name: ğŸ”’ Security Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ›¡ï¸ Check for Hardcoded Secrets
        run: |
          echo "ğŸ” Scanning for potential secret exposure..."
          
          # Patterns that might indicate secret leaks
          DANGEROUS_PATTERNS=(
            "password.*=.*['\"].*['\"]"
            "token.*=.*['\"].*['\"]"
            "secret.*=.*['\"].*['\"]"
            "key.*=.*['\"].*['\"]"
            "echo.*\${{"
            "print.*\${{"
          )
          
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ Checking: $(basename "$file")"
              
              for pattern in "${DANGEROUS_PATTERNS[@]}"; do
                if grep -E "$pattern" "$file" | grep -v "secrets\." | grep -v "#.*OK"; then
                  echo "   âš ï¸  Potential secret exposure found with pattern: $pattern"
                  grep -E "$pattern" "$file" | head -3
                fi
              done
              
              # Check for direct secret usage without env
              if grep -q "\${{ secrets\.[^ ]* }}" "$file" && ! grep -q "env:" "$file"; then
                echo "   â„¹ï¸  Consider using env variables for secrets"
              fi
            fi
          done
          
      - name: ğŸ¯ Best Practices Check
        run: |
          echo "ğŸ“š Checking for best practices..."
          
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              
              # Check for action versions
              if grep -q "uses: actions/checkout@" "$file"; then
                VERSION=$(grep "uses: actions/checkout@" "$file" | head -1 | sed 's/.*@//')
                if [[ "$VERSION" =~ ^v[1-3]$ ]]; then
                  echo "âš ï¸  '$FILENAME': actions/checkout@$VERSION is outdated (use @v4)"
                fi
              fi
              
              # Check for timeout
              if ! grep -q "timeout-minutes:" "$file"; then
                echo "â„¹ï¸  '$FILENAME': Consider adding timeout-minutes to prevent stuck workflows"
              fi
            fi
          done

  summary:
    name: ğŸ“ˆ Lint Summary
    runs-on: ubuntu-latest
    needs: [actionlint, yaml-syntax, workflow-structure, security-checks]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“Š Generate Report
        run: |
          echo "========================================"
          echo "âœ… GITHUB ACTIONS LINTING COMPLETE"
          echo "========================================"
          echo ""
          echo "ğŸ“‹ Summary of checks performed:"
          echo "1. ğŸ”§ ActionLint - Syntax and structure validation"
          echo "2. ğŸ“ YAML Syntax - Basic YAML parsing"
          echo "3. ğŸ—ï¸  Workflow Structure - Naming and conventions"
          echo "4. ğŸ”’ Security Checks - Secret exposure prevention"
          echo ""
          echo "ğŸ¯ This workflow runs on PRs that modify:"
          echo "   â€¢ .github/workflows/*.yml"
          echo "   â€¢ .github/workflows/*.yaml"
          echo ""
          echo "ğŸš€ To run manually: Go to Actions â†’ 'ğŸ” Lint GitHub Actions Workflows' â†’ Run workflow"
          echo ""
          echo "ğŸ“ Workflows in this repository:"
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs -I {} echo "   â€¢ {}" | sed 's|\.github/workflows/||'
          
      - name: ğŸ‰ Success Comment (Optional)
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **GitHub Actions Lint Passed!**\n\nAll workflow files have been validated successfully.\n\nChecks performed:\n- âœ… YAML syntax validation\n- âœ… GitHub Actions structure\n- âœ… Security best practices\n- âœ… Naming conventions\n\nYour CI/CD configuration looks good! ğŸš€'
            })
